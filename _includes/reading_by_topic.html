{% assign entries = include.data %}
{% assign sorted = entries | sort: "year" | reverse %}

{%- comment -%}
Build a unique, sorted list of topics (strings) without where_exp.
{%- endcomment -%}
{% capture topics_raw %}{% endcapture %}
{% for it in entries %}
  {% if it.topics %}
    {% for t in it.topics %}
      {% capture token %}||{{ t }}||{% endcapture %}
      {% unless topics_raw contains token %}
        {% capture topics_raw %}{{ topics_raw }}{{ token }}{% endcapture %}
      {% endunless %}
    {% endfor %}
  {% endif %}
{% endfor %}
{% assign topics = topics_raw | split: "||" | uniq | sort %}

{%- comment -%}
Detect untagged entries (Misc).
{%- endcomment -%}
{% assign has_misc = false %}
{% for it in entries %}
  {% unless it.topics and it.topics != empty %}
    {% assign has_misc = true %}
    {% break %}
  {% endunless %}
{% endfor %}

{%- comment -%}
Optional manual order: if _data/reading_topics.yml provides `order: [...]`,
use it verbatim (even if some topics end up empty).
{%- endcomment -%}
{% if site.data.reading_topics and site.data.reading_topics.order %}
  {% assign topics = site.data.reading_topics.order %}
{% endif %}

<!-- Topic pills -->
<nav class="toc-topics" aria-label="Topics">
  {% for topic in topics %}
    {% assign anchor = topic | slugify %}
    {% assign count = 0 %}
    {% for it in entries %}
      {% if it.topics and it.topics contains topic %}
        {% assign count = count | plus: 1 %}
      {% endif %}
    {% endfor %}
    <a class="toc-pill" href="#topic-{{ anchor }}">{{ topic }} <span class="toc-count">{{ count }}</span></a>
  {% endfor %}

  {% if has_misc %}
    {% assign misc_count = 0 %}
    {% for it in entries %}
      {% unless it.topics and it.topics != empty %}
        {% assign misc_count = misc_count | plus: 1 %}
      {% endunless %}
    {% endfor %}
    <a class="toc-pill" href="#topic-misc">Misc <span class="toc-count">{{ misc_count }}</span></a>
  {% endif %}
</nav>

<!-- One table per topic -->
{% for topic in topics %}
  {% assign anchor = topic | slugify %}

  <section class="topic-section" id="topic-{{ anchor }}">
    <h2 class="topic-title">{{ topic }}</h2>

    <div class="table-wrap">
      <table class="reading-table">
        <thead>
          <tr>
            <th style="width: 6ch;">Year</th>
            <th>Paper</th>
            <th style="width: 22%;">Venue</th>
          </tr>
        </thead>
        <tbody>
          {% for it in sorted %}
            {% if it.topics and it.topics contains topic %}
              <tr>
                <td class="year">{{ it.year }}</td>
                <td class="title">
                  {% if it.url %}<a href="{{ it.url }}" target="_blank" rel="noopener">{{ it.title }}</a>{% else %}{{ it.title }}{% endif %}
                  {% if it.authors %}<div class="authors">{{ it.authors }}</div>{% endif %}
                  {% if it.topics and it.topics.size > 1 %}
                    <div class="topics">
                      {% for t in it.topics %}
                        {% unless t == topic %}
                          <a href="#topic-{{ t | slugify }}" class="topic-chip">{{ t }}</a>
                        {% endunless %}
                      {% endfor %}
                    </div>
                  {% endif %}
                </td>
                <td class="venue">{% if it.venue %}{{ it.venue }}{% endif %}</td>
              </tr>
            {% endif %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
{% endfor %}

{% if has_misc %}
  <section class="topic-section" id="topic-misc">
    <h2 class="topic-title">Misc</h2>
    <div class="table-wrap">
      <table class="reading-table">
        <thead>
          <tr>
            <th style="width: 6ch;">Year</th>
            <th>Paper</th>
            <th style="width: 22%;">Venue</th>
          </tr>
        </thead>
        <tbody>
          {% for it in sorted %}
            {% unless it.topics and it.topics != empty %}
              <tr>
                <td class="year">{{ it.year }}</td>
                <td class="title">
                  {% if it.url %}<a href="{{ it.url }}" target="_blank" rel="noopener">{{ it.title }}</a>{% else %}{{ it.title }}{% endif %}
                  {% if it.authors %}<div class="authors">{{ it.authors }}</div>{% endif %}
                </td>
                <td class="venue">{% if it.venue %}{{ it.venue }}{% endif %}</td>
              </tr>
            {% endunless %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
{% endif %}
